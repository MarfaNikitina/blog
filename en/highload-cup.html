<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Clojure in Highload Cup</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="http://0.0.0.0:4000/en/highload-cup">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="http://0.0.0.0:4000/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

</head>


  <body>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33533163-2', 'auto');
    ga('send', 'pageview');

</script>

    <header class="site-header">

    <div class="wrapper">

        <div id="logo-handler">
            <a href="/">
              <img src="/assets/static/photo-round-small.png">
            </a>
        </div>

      <a id="home-link" href="/">Ivan Grishaev's blog</a>
      <small>Writing on programming, education, books and negotiations.
</small>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About me</a>
          
        
          
          <a class="page-link" href="/bookshelf">Bookshelf</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

        <a class="page-link" href="/feed.xml">RSS</a>
        <div id="search-form">
    <form method="get" action="/search/" style="display: inline">
        <input name="q" placeholder="Поиск">
        <button style="border: none; background-color: transparent; cursor: pointer;" type="submit">&#x1f50d;</button>
    </form>
</div>

      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Clojure in Highload Cup</h1>
    <p class="post-meta">
      <time datetime="2017-09-15T00:00:00+00:00" itemprop="datePublished">Sep 15, 2017</time>

      

      <a href="/tag/highload/" rel="tag">highload</a>, <a href="/tag/mail.ru/" rel="tag">mail.ru</a>, <a href="/tag/clojure/" rel="tag">clojure</a>
    </p>

  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>1st September was the day when the <a href="https://highloadcup.ru/">Highload Cup</a> competition has
finished. I’m proud of I took participation in it. The Cup was a quite
interesting event full of drive, enthusiasm and night coding. Although I haven’t
taken any prize, I’ve got lots of fun and new knowledge that I’ve partially
shared with you in my previous publications.</p>

<p>In that post, I’m going to highlight some technical details unmentioned before.</p>

<p>A minute of vanity: I’m a single developer who used Clojure/Datomic stack to
implement a solution. And by the way a single member from my hometown Voronezh
(my colleagues who live here argued on Cup passionately but still without a
result).</p>

<p>The task was easy only at first glance. For non-Russian speakers, let me retell
it quickly. You’ve got three entities: a user, a location and a visit. They
represent, respectively, a physical person, a place in the world and a fact that
somebody visited a place and put mark for it. Say, the last year John Doe
visited Siberia and was so excited that he put 5 stars.</p>

<p>Your task is to ship a Docker container that carries a REST server. The server
should implement basic CRUD operations on users, locations and visits. All the
data pass in and out using JSON.</p>

<p>In addition to CRUD, there are two aggregate APIs. The first one is to return
all the places visited by specific user. The second one is to return an average
mark assigned to specific location by all the users who have ever visited
it. Both APIs accept optional query string arguments to filter the results by
foreign entities. Say, <code class="highlighter-rouge">fromAge</code> parameter stands for we need to consider only
those people who are alder than that number, <code class="highlighter-rouge">distanceTo</code> limits those locations
with distances less than the passed value and so on.</p>

<p>Once you’ve built a Docker container, you submit it to the central server where
it is shot with a special software. It considers lots of such facts as proper
response codes, incorrect data filtering, response time and so on. Than it
calculates your rank. The less is the rank, the better your position is.</p>

<p>Sounds simple, but I spent a week trying to implement fast Clojure
solution. TL/DR: finally, the C++ guys have come and taken the top of the rank
table. Some of them wrote their own HTTP server. But still, it was quite fun to
compete with them.</p>

<p>As the Cup has finished, you are welcome to <a href="https://github.com/igrishaev/highloadcup">review my code</a> (it was
private before due to Cup rules). The final version uses Clojure
1.9, <a href="http://www.datomic.com/">Datomic</a> free edition and <a href="https://clojure.org/guides/spec">clojure.spec</a> to validate
incoming data. There were some experiments with SQLite database kept in memory
but at the end I finished with Datomic (more on that below).</p>

<p>So here are some technical details that I wanted to discuss.</p>

<h3 id="reading-zip-on-the-fly">Reading ZIP on the fly</h3>

<p>According to the Cup’s rules, when your application starts, it finds the input
data in <code class="highlighter-rouge">/tmp/data</code> directory. There is a single zip archive with JSON files
inside. The Docker container is mount with read-only file system, so you cannot
unzip it using standard Unix tools. Instead, you should read the data directly
using streams.</p>

<p>Thanks to Java, it ships <code class="highlighter-rouge">java.util.zip</code> package with all we need
inside. Surprisingly, I ended up with quite short code to read the file:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-zip</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="nf">java.util.zip.ZipFile.</span><span class="w"> </span><span class="nb">path</span><span class="p">)</span><span class="w">
    </span><span class="n">entries</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">.entries</span><span class="w"> </span><span class="n">enumeration-seq</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="n">entries</span><span class="p">]</span><span class="w">
   </span><span class="p">(</span><span class="nf">.getInputStream</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">e</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>It accepts path to a zip file and returns a lazy sequence of input streams. Each
stream might be read into a data structure with a function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-stream</span><span class="w"> </span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="nf">json/parse-stream</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>, where <code class="highlighter-rouge">json</code> is an alias to the <a href="https://github.com/dakrone/cheshire">Cheshire</a> library included as
<code class="highlighter-rouge">[cheshire.core :as json]</code> at the top of the namespace.</p>

<h3 id="the-data-backend">The data backend</h3>

<p>Since the beginning it was obvious to keep the data in memory but not on the
disk. I was thinking on whether I should use in-memory SQLite backend or use
Datomic within in-memory storage. After all, I’ve tried both options and ended
up with Datomic finally.</p>

<p>With SQLite, I’ve got only one trouble when connecting to the database. I
described the problem in details in my previous
post <a href="http://grishaev.me/en/clj-sqlite">“In-Memory SQLite Database In Clojure”</a>. For the rest, it
worked fine. I used <a href="https://www.hugsql.org/">HugSQL</a> to compose queries like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name get-location-avg :? :1</span>
<span class="k">select</span>
  <span class="k">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">mark</span><span class="p">)</span> <span class="k">as</span> <span class="k">avg</span>
<span class="k">from</span> <span class="n">visits</span> <span class="n">v</span>
<span class="cm">/*~ (when (or (:fromAge params) (:toAge params) (:gender params)) */</span>
<span class="k">join</span> <span class="n">users</span> <span class="n">u</span> <span class="k">on</span> <span class="n">v</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="cm">/*~ ) ~*/</span>
<span class="k">where</span>
  <span class="n">v</span><span class="p">.</span><span class="k">location</span> <span class="o">=</span> <span class="p">:</span><span class="n">location_id</span>
  <span class="cm">/*~ (when (:fromDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">fromDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">toDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:fromAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">fromAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">toAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:gender params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">gender</span> <span class="o">=</span> <span class="p">:</span><span class="n">gender</span>
  <span class="cm">/*~ ) ~*/</span>
</code></pre></div></div>

<p>Then I switched to Datomic backend. I was wondering whether it would be slower
than good old SQLite. The results were in favor of Datomic: it was about 1.5
times faster when returning responses.</p>

<p>For in-memory backend, you do not need a registered version or a license
key. Just add <code class="highlighter-rouge">[com.datomic/datomic-free "0.9.5561.54"]</code> into dependencies list
and I’ve done. Then pass something like <code class="highlighter-rouge">"datomic:mem://highloadcup"</code> when
connecting to the database.</p>

<p>It was a good decision to create common functions for CRUD operations
(create-user, update-user, etc). In fact, I had only three general functions to
create, update and read for something, and the entity-specific functions became
just partials on them.</p>

<p>Having that, I could quickly switch from SQLite-powered backed to Datomic.</p>

<p>The only think I’ve got stuck on was applying optional filters to a query. That
became a reason to write <a href="http://grishaev.me/en/datomic-query">“Conditional Queries in Datomic”</a>
article.</p>

<p>You may examine Datomic database backend in <a href="https://github.com/igrishaev/highloadcup/blob/master/src/highloadcup/db.clj">master branch</a> whereas
SQLite version lives in a <a href="https://github.com/igrishaev/highloadcup/blob/sqlte/src/highloadcup/db.clj">self-titled branch</a>.</p>

<h3 id="json-validation">JSON validation</h3>

<p>A system that tests you server tends to send incorrect data. If you accept it
without returning <code class="highlighter-rouge">400 Bad Request</code> status you will get penalty score. So the
validation is a major part of our application.</p>

<p>Before, I used <a href="https://github.com/plumatic/schema/">Schema</a> module for that purpose. I know it well
including some of its shadowed parts. But having Clojure 1.9 on board was a
great chance to try <a href="https://clojure.org/guides/spec">clojure.spec</a> that is still in alpha but works great.</p>

<p>After some REPL experiments, I ended up with my own <code class="highlighter-rouge">highloadcup.spec</code> namespace
that carried wrappers around the original spec. One of them is <code class="highlighter-rouge">validate</code>
function that does the following:</p>

<ol>
  <li>validates the data against a spec;</li>
  <li>coerces string numbers into integers when needed;</li>
  <li>returns <code class="highlighter-rouge">nil</code> when the data is invalid.</li>
</ol>

<p>Its code is</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">highloadcup.spec</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.spec.alpha</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="no">:clojure.spec.alpha/invalid</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="p">[</span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conform</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when-not</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">invalid</span><span class="p">)</span><span class="w">
   </span><span class="n">result</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention it’s a good practice to declare <code class="highlighter-rouge">invalid</code> constant at the
top. Once the library becomes stable, its namespace will get rid of “alpha”.</p>

<p>Another point, spec was designed to be used with full-qualified keys. But in my
case, all the keys were without namespaces. That’s normal for non-Clojure
applications. Declare your specs as usual, but once you compose a map of them,
pass <code class="highlighter-rouge">:opt-un</code> parameter (stands for “unqualified”):</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">enum-gender</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="s">"m"</span><span class="w"> </span><span class="s">"f"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/id</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/first_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/last_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/gender</span><span class="w"> </span><span class="n">enum-gender</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/birth_date</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/create</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:req-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/id</span><span class="w">
                  </span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>This is a spec for creating a user where every field is required. For updating a
user, there is a similar spec with all the fields optional:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/update</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>When applying query string filters, they are all plain strings even when
represent numbers. Turning them to the proper type is also knowing as
coercion. To coerce a string value during validation, use <code class="highlighter-rouge">conformer</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">x-integer?</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">integer?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">string?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">try</span><span class="w">
    </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
     </span><span class="n">invalid</span><span class="p">))</span><span class="w">
   </span><span class="n">invalid</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-&gt;int</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conformer</span><span class="w"> </span><span class="n">x-integer?</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/fromDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/country</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDistance</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/params</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:opt.visits/fromDate</span><span class="w">
          </span><span class="no">:opt.visits/toDate</span><span class="w">
          </span><span class="no">:opt.visits/country</span><span class="w">
          </span><span class="no">:opt.visits/toDistance</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Now, then you validate parameters taken from the Ring request against
<code class="highlighter-rouge">:opt.visits/params</code> spec, all the numbers represented with strings will be
turned into integers as well.</p>

<h3 id="docker">Docker</h3>

<p>Let’s talk a bit about building a Docker container. I don’t see any reason to
compile uberjar inside Docker. It’s Java so that it is “compiled once, works
everywhere” (usually I’m sceptical on that point, but not now). All you need is
to copy an uberjar file into container and setup CMD properly.</p>

<p>Do not use the official <a href="https://hub.docker.com/_/java/">Java template</a>. Under the hood, it ships
OpenJDK that is 1.5 times slower than OracleJDK, unfortunately. So I had to
inherit my image from <a href="https://hub.docker.com/r/frolvlad/alpine-oraclejdk8/">Vlad Frolov’s one</a>. I know that’s
illegal to distribute Java runtime as a part of your application. But the
difference in score was more important these days.</p>

<p>JVM flags also could help to tweak performance. The web pages I’ve found
googling for “java docker” said that Java has troubles detecting heap size when
running in Docker. So at least <code class="highlighter-rouge">"-Xmx"</code> and <code class="highlighter-rouge">"-Xms"</code> should be specified. Next
two, <code class="highlighter-rouge">"-da"</code> and <code class="highlighter-rouge">"-dsa"</code> reduce all the assert statements. See the rest of
flags in my <a href="https://github.com/igrishaev/highloadcup/blob/master/Dockerfile">Dockerfile</a>.</p>

<p>All the project duties (lein, docker, files) should be automated with good
old <a href="https://github.com/igrishaev/highloadcup/blob/master/Makefile">Make</a> utility. Ideally, the default target should build the
entire project from scratch.</p>

<h3 id="acknowledgments">Acknowledgments</h3>

<p>I want to thank <a href="https://mail.ru/">Mail.ru</a> team who were responsible for handling that
Cup. They’ve done really huge amount of work. I thought they didn’t sleep at
all. During the three weeks term, they’ve been answering all the questions in
chat, fixing the infrastructure, solving bugs, writing wiki and adapting the
official website.</p>

<p>Thank you guys, your are real professionals!</p>

<p><strong>PS</strong> to my Russian readers: you are welcome to share that post with your
foreign colleagues. Next time, let them join Highload Cup too!</p>

  </div>

</article>

<div id="disqus_thread"></div>
<script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//igrishaev.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/igrishaev"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">igrishaev</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/i_grishaev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">i_grishaev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
