<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Mozilla makes me crazy</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="http://grishaev.me/en/mozilla/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="http://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

</head>


  <body>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33533163-2', 'auto');
    ga('send', 'pageview');

</script>

    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container" style="justify-content: space-between">

                <div>
                    <div class="flex-container">
                        <p style="margin-bottom: 5px">
                            Ivan Grishaev's blog
                            <br>
                            <small>Writing on programming, education, books and negotiations.
</small>
                        </p>
                    </div>
                </div>

                <div>
                    
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search"
      itemprop="potentialAction"
      itemtype="http://schema.org/SearchAction">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>

                </div>

            </div>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Mozilla makes me crazy</h1>
    <p class="post-meta">
      <time datetime="2017-11-10T00:00:00+00:00" itemprop="datePublished">Nov 10, 2017</time>

      

      <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/mozilla/" rel="tag">mozilla</a>, <a href="/tag/rust/" rel="tag">rust</a>
    </p>

    <script src="https://yastatic.net/es5-shims/0.0.2/es5-shims.min.js"></script>
<script src="https://yastatic.net/share2/share.js"></script>
<div class="ya-share2" data-services="twitter,telegram,facebook,vkontakte,lj,evernote,linkedin,reddit" data-limit="4"></div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>What I’d like to share with you is my suffering from dealing with browsers. I’m
an author of a <a href="https://github.com/igrishaev/etaoin">Clojure library</a> that automates browsers. Briefly, the
library doesn’t depend on Selenium since it implements
the <a href="https://www.w3.org/TR/webdriver">Webdriver protocol</a> with pure Clojure. It brings flexibility and
freedom in the way you’d like to build your API.</p>

<p>At the same time, everybody who is willing to tame several browsers at once is
doomed to open the Pandora box. There is the <a href="https://www.w3.org/TR/webdriver">official standard</a> I
thought, so definitely everybody will follow it. A naive laddie I was.</p>

<p>I don’t know if there is some kind of curse or black magic, but sometimes
developers cannot just implement the standard as it dictates the things should
be done. For example, it says the server should accept a <code class="highlighter-rouge">value</code>
field. Developers write code that takes <code class="highlighter-rouge">text</code> instead. When I see it, I have
strange feeling of being completely stunned without any understanding of what’s
going on here.</p>

<p>But what exactly I wanted to discuss is how does Mozilla develop their software.</p>

<p>Briefly, they break everything apart moving further. And I don’t know how to
deal with it. Maybe they enjoy coding in Rust so much that their mission to ship
good software has faded away.</p>

<p>I know I’m not a Mozilla engineer and would never be capable of joining them,
but still. As a user of their products, namely Geckodriver and Webdriver
utilities, I consider myself being right when criticizing them.</p>

<p>With each <a href="https://github.com/mozilla/geckodriver/releases">next release</a> of Geckodriver, it behaves worth and
worth. When I first started developing the library (a bit less then 1 year ago),
it was 0.13 version available and it worked fine. I wrote a bunch of unit tests
that all passed. Nowadays, the latest version is 0.19 and it just doesn’t work.</p>

<p>Yes, you heard correct, it does not even respond to any API call:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.19.0
1510326430666 geckodriver INFO geckodriver 0.19.0
1510326430680 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
</code></pre></div></div>

<p>Calling <code class="highlighter-rouge">curl</code> utility throws a long stack trace saying something about sandbox
restrictions without any word on how to fix that or at least where to look for
help.</p>

<p>Here is a <a href="https://github.com/mozilla/geckodriver/issues/706">related issue</a> that confirms I’m not the first one who faced
it. It’s closed! “As I said, this isn’t a problem with geckodriver”, one of
developers says. OK, but I’m still curious about why does the version <code class="highlighter-rouge">0.13</code>
work fine whereas switching on <code class="highlighter-rouge">0.19</code> leads to failure? Proof:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.13.0 <span class="nt">--version</span>
geckodriver 0.13.0

~/Downloads&gt; ./geckodriver-0.13.0
1510327215587 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">{</span><span class="s2">"sessionId"</span>:<span class="s2">"e744bbdd-1b3f-9249-827f-02204bbc81c8"</span>,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"acceptInsecureCerts"</span>:...
</code></pre></div></div>

<p>Ok, let’s decrease the version a bit. I downloaded them moving backwards in
time. Again, <code class="highlighter-rouge">0.18</code> still does not work. We need to go deeper. The previous one
numbered with <code class="highlighter-rouge">0.17</code> starts well, but suddenly, I cannot fetch a new session
with my library, it just returns <code class="highlighter-rouge">nil</code> value. That’s strange.</p>

<p>Going down to <code class="highlighter-rouge">0.15</code>. Don’t know why, but I cannot fill any input field, the API
fails with a strange error saying I didn’t pass the “text” field. Hm, I clearly
remember that the API accepts “value” field. That’s what
the <a href="https://www.w3.org/TR/webdriver/#dfn-element-send-keys">W3C standard says</a>. Geckodriver 0.13 follows it, but not the
0.15 release! After fetching the official <a href="https://hg.mozilla.org/mozilla-central/">Mozilla repo</a> and
searching in its history for a while, I found this (truncated):</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff -r 225d1faf513b -r b429bf0078c4 testing/webdriver/src/command.rs
</span><span class="gd">--- a/testing/webdriver/src/command.rs	Tue Mar 07 18:50:56 2017 +0000
</span><span class="gi">+++ b/testing/webdriver/src/command.rs	Wed Mar 15 13:54:19 2017 +0000
</span><span class="gu">@@ -752,7 +752,7 @@
</span>
 #[derive(PartialEq)]
 pub struct SendKeysParameters {
<span class="gd">-    pub value: Vec&lt;char&gt;
</span><span class="gi">+    pub text: String
</span> }

 impl Parameters for SendKeysParameters {
<span class="gu">@@ -760,26 +760,14 @@
</span>         let data = try_opt!(body.as_object(),
                             ErrorStatus::InvalidArgument,
...
<span class="gd">-            Ok(chars[0])
-        }).collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;());
</span><span class="gi">+        let text = try_opt!(try_opt!(data.get("text"),
</span>...
<span class="gi">+            text: text.into()
</span>         })
     }
 }
<span class="gu">@@ -787,10 +775,7 @@
</span> impl ToJson for SendKeysParameters {
     fn to_json(&amp;self) -&gt; Json {
         let mut data = BTreeMap::new();
<span class="gd">-        let value_string: Vec&lt;String&gt; = self.value.iter().map(|x| {
-            x.to_string()
-        }).collect();
-        data.insert("value".to_string(), value_string.to_json());
</span><span class="gi">+        data.insert("value".to_string(), self.text.to_json());
</span>         Json::Object(data)
     }
 }

</code></pre></div></div>

<p>Hold on, what was the purpose to change that field? Everything was working,
right? Who asked for that? Did the standard change? No, it’s still the same! Why
have you guys just changed the API? You could easily rewrite the code without
renaming “value” field into “text”.</p>

<p>Listen, I’ve already got three different versions of those API for Chrome,
Firefox and Safari. In addition to that, your force me to switch on version
inside Firefox branch turning my code into if/else hell.</p>

<p>From your perspectives, what’s the difference in processing either “value” or
“text” field? But for me, you’ve broken my software! It doesn’t work anymore.</p>

<p>I could not find a diff that would proof the fact of moving “sessionId” field
because the repo’s history is pretty complicated. But it’s easy to check that.
The version 0.17 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"sessionId"</span><span class="p">:</span><span class="s2">"4decec3e-e564-b349-bb41-b27b5f307e01"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"value"</span><span class="p">:{</span><span class="w">
    </span><span class="s2">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"browserVersion"</span><span class="p">:</span><span class="s2">"52.0
    ...
</span></code></pre></div></div>

<p>whereas 0.13 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s2">"value"</span><span class="p">:{</span><span class="w">
  </span><span class="s2">"sessionId"</span><span class="p">:</span><span class="s2">"d0dc41f8-9c17-934e-be2b-708c72f0fb9c"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"capabilities"</span><span class="p">:{</span><span class="w">
    </span><span class="s2">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>Look, they just wrapped the whole data into “value” subfield shifting it one
level below. Again, what was the purpose of doing this? Did you think of those
users who have already been using your code for some time?</p>

<p>Thanks to those weird changes, I need to refactor my code just because Mozilla
guys decided to rename something. And more over that, thank you for not sending
back the driver’s version in API responses. It would be not so challenging when
having it.</p>

<p>I wonder why has Chromedriver been working all that time without errors? It’s
written in <a href="https://github.com/bayandin/chromedriver/tree/master/client">C++ and Python</a> and the code is quite simple and
linear. And it’s much stable then its Rust-driven rival.</p>

<p>OK, it’s time to summarize all together. I don’t think that anybody will share
my misery on the subject. The Webdriver spec is quite specific thing, so who
would really care…</p>

<p>But the main point of that talk is you should never break backward capability
even at the gunpoint. Just keep things working, that’s the main priority when
you change something. Extend, but not truncate your product. And really, just
use it sometimes in a way that an ordinary user does.</p>

  </div>

</article>

<div id="disqus_thread"></div>
<script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//igrishaev.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/igrishaev"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">igrishaev</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/i_grishaev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">i_grishaev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
