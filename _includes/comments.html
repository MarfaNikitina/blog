
{% assign comments = site.comments | where:'post', include.permalink %}

{% if comments.size == 0 %}

<center>Комментариев пока нет</center>

{% else %}

<center>Комментарии</center>

<div id="comments-block">
  {% for comment in comments %}
    <div class="comment-block">
      <p class="comment-lead">
        <small>
          <em>{{ comment.author_fullname or comment.author_nickname }}, {{ comment.date | date_to_string: "ordinal", "RU" }}</em>
        </small>
      </p>
      <div>{{ comment.content | markdownify }}</div>
    </div>
  {% endfor %}
</div>

{% endif %}

<form class="comment-form">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
    <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea id="comment-form-comment" name="comment"></textarea>
    </div>

    <div class="block">
        <button onclick="sendComment()" id="comment-form-send" type="button">Send</button>
    </div>

</form>

<script>

function sendComment() {

    var el_author = document.getElementById("comment-form-author");
    var el_comment = document.getElementById("comment-form-comment");
    var el_send = document.getElementById("comment-form-send");

    var author = el_author.value;
    var comment = el_comment.value;
    var path = "{{ include.permalink }}";

    if (!author) {
        alert("The name is empty");
        return;
    }

    if (!comment) {
        alert("The comment is empty");
        return;
    }

    if (!path) {
        alert("The path is empty");
        return;
    }

    var payload = {
        author: author,
        comment: comment,
        path: path
    };

    el_send.disabled = true;

    fetch("{{ site.comment_path }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json; charset=utf-8"
        },
        body: JSON.stringify(payload)
    })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            alert(data.message);
            var comment = el_comment.value = "";
        })
        .catch(function (error) {
            console.log(error);
            alert("Something went wrong.");
        })
        .finally(function () {
            el_send.disabled = false;
        });

}

</script>
